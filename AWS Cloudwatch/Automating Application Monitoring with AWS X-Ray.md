
# CloudWatch Synthetics Notes

## Overview
- **Purpose**: Monitors applications (sites, API endpoints, web workflows) from an external perspective, simulating real customer actions and experiences.
- **Importance**: Ensures seamless integration of application components (containers, microservices, serverless functions, third-party services) to deliver superior customer experience.
- **Proactive Monitoring**: Identifies and addresses issues before they impact customers.

## Key Features of Amazon CloudWatch Synthetics
1. **Configurable Scripts (Canaries)**:
   - Create scripts to monitor API endpoints and websites.
   - Mimic customer actions to verify user experience without real customer traffic.
   - **Example Code Snippet for a Basic Canary Script** (Node.js example for API endpoint monitoring):
     ```javascript
     const synthetics = require('Synthetics');
     const log = require('SyntheticsLogger');

     exports.handler = async () => {
         let url = "https://api.example.com/health";
         let requestOptions = {
             hostname: 'api.example.com',
             method: 'GET',
             path: '/health',
             protocol: 'https:'
         };

         let response = await synthetics.executeHttpStep('Check API Health', requestOptions);
         log.info("API Response Status: " + response.statusCode);
         if (response.statusCode !== 200) {
             throw new Error("API health check failed!");
         }
     };
     ```

2. **Flexible Execution**:
   - Run canaries once or on a schedule (as frequently as once per minute).
   - Provides 24/7 monitoring coverage.

3. **Monitoring Capabilities**:
   - Checks availability and latency of endpoints.
   - Monitors website content for consistency and performance.

4. **Integration with CloudWatch**:
   - Set up alarms for issue detection.
   - Receive notifications for prompt issue resolution.
   - **Example CloudWatch Alarm Configuration** (via AWS CLI):
     ```bash
     aws cloudwatch put-metric-alarm \
         --alarm-name CanaryFailureAlarm \
         --metric-name SuccessPercent \
         --namespace AWS/Synthetics \
         --threshold 90.0 \
         --comparison-operator LessThanThreshold \
         --evaluation-periods 1 \
         --period 60 \
         --statistic Average \
         --alarm-actions arn:aws:sns:region:account-id:my-sns-topic
     ```

## Benefits
- Simulates real customer experiences to ensure application performance.
- Helps maintain a seamless and positive user experience by proactively addressing issues.

## Next Steps
- Learn how to create a canary in the AWS Management Console or via AWS SDK/CLI in the next section.


# Creating a Simple Synthetic Canary Notes

## Overview
- **Purpose**: Set up a basic synthetic canary in AWS CloudWatch to monitor an application's endpoint (e.g., heartbeat monitoring for a single URL).
- **Location**: AWS CloudWatch > Application monitoring > Synthetics Canaries.

## Steps to Create a Canary
1. **Access Synthetics Canaries**:
   - Navigate to AWS CloudWatch homepage.
   - Scroll to **Application monitoring** and select **Synthetics Canaries**.

2. **Choose Creation Method**:
   - **Blueprint**: Recommended for beginners. Predefined templates for common use cases (e.g., heartbeat monitoring).
   - **Inline Editor**: For advanced users to write custom scripts.
   - **Import from S3**: Use pre-existing canary scripts stored in S3.
   - **Demo Choice**: Use **Heartbeat Monitoring Blueprint** for basic page load monitoring.

3. **Configure the Canary**:
   - **Name**: Assign a name (e.g., test for "scorekeep" application).
   - **URL**: Provide the endpoint URL (e.g., `https://scorekeep.example.com`).
     - Remove unnecessary parts like hashtags from the URL.
   - **Additional Endpoints**: Option to add more URLs (not used in demo).
   - **Screenshots**: Enable to capture screenshots during canary execution (default: enabled).
   - **Script Editor**: View or modify the JavaScript code (default blueprint code used in demo).
     - **Example Heartbeat Canary Script** (auto-generated by blueprint, simplified):
       ```javascript
       const synthetics = require('Synthetics');
       const log = require('SyntheticsLogger');

       exports.handler = async () => {
           let url = "https://scorekeep.example.com";
           let requestOptions = {
               hostname: 'scorekeep.example.com',
               method: 'GET',
               path: '/',
               protocol: 'https:'
           };

           let response = await synthetics.executeHttpStep('Check Page Load', requestOptions);
           log.info("Page Load Status: " + response.statusCode);
           if (response.statusCode !== 200) {
               throw new Error("Page load failed!");
           }
       };
       ```

4. **Set Schedule**:
   - Options: Run continuously, use a CRON expression, or run once.
   - **Demo Choice**: Use default schedule (continuous monitoring).

5. **Create Canary**:
   - Click to create, and upon completion, redirect to the canary homepage.

## Post-Creation Analysis
- **Canary Homepage**:
   - Displays all canaries and their status.
   - Check the last run status (e.g., "passed" for successful execution).
- **Details Available**:
   - **Steps Executed**: Lists executed steps (e.g., single step for page load).
   - **Screenshots**: View captured screenshots of the application.
   - **Logs**: Debug canary execution.
   - **HAR File**: Contains network requests made during page load (similar to browser Network tab).
     - Analyze request times to identify slow components.
     - **Example HAR File Analysis** (simplified JSON structure):
       ```json
       {
         "log": {
           "entries": [
             {
               "request": {
                 "method": "GET",
                 "url": "https://scorekeep.example.com/index.html"
               },
               "response": {
                 "status": 200,
                 "statusText": "OK"
               },
               "time": 120
             }
           ]
         }
       }
       ```

## Benefits
- **Ease of Setup**: Simple setup with a few clicks for basic monitoring.
- **Use Case**: Ideal for monitoring landing pages to ensure fast load times and availability.
- **Output**: Provides screenshots, logs, and network request data for performance analysis.

## Next Steps
- Explore creating advanced canaries for API endpoint monitoring.


# Monitoring APIs with Synthetic Canaries Notes

## Overview
- **Purpose**: Create a synthetic canary to monitor serverless API endpoints (e.g., AWS API Gateway) by simulating real user interactions.
- **Application**: Test an API (e.g., "cloudwatchapi") with a two-step canary: create an item (POST) and retrieve it by ID (GET).

## Steps to Create an API Canary
1. **Navigate to CloudWatch**:
   - Go to AWS CloudWatch Management Console > Application monitoring > Synthetics Canaries > Create new canary.

2. **Select Blueprint**:
   - Choose **API Canary** blueprint for API endpoint monitoring.
   - Name the canary (e.g., `serverlessapi`).

3. **Configure API Gateway**:
   - Select "I'm using Amazon API Gateway".
   - Choose the API (e.g., `cloudwatchapi`) and stage (e.g., `Production`).
   - Hostname is auto-filled based on API selection.

4. **Add HTTP Requests**:
   - **Step 1: Create New Item (POST)**:
     - Resource: Base URL.
     - Method: POST.
     - Payload: JSON with `id` (e.g., `5`) and `name` (e.g., `canary-demo`).
     - Name the step: `Create new item`.
     - Uncheck "Continue if step fails" (stops execution if POST fails).
   - **Step 2: Get Created Item (GET)**:
     - Resource: GET by ID.
     - Method: GET.
     - Path: Include `id` (e.g., `/production/5`, initially hardcoded).
     - Name the step: `Get created item`.

5. **Modify Script for Dynamic Payload**:
   - Edit the JavaScript in the script editor to generate random `id` and `name`.
   - **Example Modified Canary Script**:
     ```javascript
     const synthetics = require('Synthetics');
     const log = require('SyntheticsLogger');

     // Function to generate random payload
     function generateRandomPayload() {
         const randomId = Math.floor(Math.random() * 10000);
         return {
             id: randomId,
             name: `canary-demo-${randomId}`
         };
     }

     exports.handler = async () => {
         // Step 1: Create new item
         const randomPayload = generateRandomPayload();
         let requestOptionsStep1 = {
             hostname: 'api.example.com',
             method: 'POST',
             path: '/production',
             protocol: 'https:',
             body: JSON.stringify(randomPayload)
         };
         let response1 = await synthetics.executeHttpStep('Create new item', requestOptionsStep1);
         log.info("Create Item Status: " + response1.statusCode);
         if (response1.statusCode !== 200) {
             throw new Error("Create item failed!");
         }

         // Step 2: Get created item
         let requestOptionsStep2 = {
             hostname: 'api.example.com',
             method: 'GET',
             path: `/production/${randomPayload.id}`,
             protocol: 'https:'
         };
         let response2 = await synthetics.executeHttpStep('Get created item', requestOptionsStep2);
         log.info("Get Item Status: " + response2.statusCode);
         if (response2.statusCode !== 200) {
             throw new Error("Get item failed!");
         }
     };
     ```

6. **Create and Run Canary**:
   - Save and create the canary.
   - Check the canary status (e.g., `serverlessapi`) on the canary homepage.
   - Verify both steps (`Create new item` and `Get created item`) pass.

7. **Enable Request/Response Body Logging**:
   - Initially, request/response bodies are not logged.
   - Edit the canary: Actions > Edit > Script editor.
   - Update `includeRequestBody` and `includeResponseBody` to `true` for both steps.
   - **Example Configuration Update**:
     ```javascript
     let requestOptionsStep1 = {
         hostname: 'api.example.com',
         method: 'POST',
         path: '/production',
         protocol: 'https:',
         body: JSON.stringify(randomPayload),
         config: {
             includeRequestHeaders: true,
             includeRequestBody: true,
             includeResponseBody: true
         }
     };
     let requestOptionsStep2 = {
         hostname: 'api.example.com',
         method: 'GET',
         path: `/production/${randomPayload.id}`,
         protocol: 'https:',
         config: {
             includeRequestHeaders: true,
             includeRequestBody: true,
             includeResponseBody: true
         }
     };
     ```
   - Save and wait for the next run to see request/response bodies in logs.

8. **Analyze Results**:
   - Check canary run details for step status, request/response bodies, and random ID (e.g., `5431`).
   - Use logs to verify payload and response data.

## Benefits
- **Proactive Monitoring**: Simulates real user interactions to ensure API availability and performance.
- **Early Issue Detection**: Identifies issues before they impact users.
- **Dynamic Testing**: Random payloads improve test coverage for realistic scenarios.

## Next Steps
- Enhance canary with additional API endpoints or complex workflows.
- Integrate with CloudWatch alarms for automated notifications.


# Using the Canary Recorder Plugin Notes

## Overview
- **Purpose**: Simplify the creation of synthetic canaries for testing web applications by recording user interactions in the browser.
- **Use Case**: Automate testing of complex user flows (e.g., clicking elements, logging in, entering text) in applications like the "scorekeep" app.
- **Tool**: AWS CloudWatch Synthetics Recorder plugin for browsers (e.g., Chrome).

## Steps to Create a Canary with the Recorder Plugin
1. **Install the Canary Recorder Plugin**:
   - Navigate to AWS CloudWatch Management Console > Synthetics Canaries > Create new canary.
   - Select the Canary Recorder option, which provides a link to install the browser extension.
   - Install the extension (e.g., for Chrome: click "Add to Chrome" > "Add extension").
   - Close the installation window after adding.

2. **Record User Interactions**:
   - Open the target application (e.g., `scorekeep` app).
   - Access the CloudWatch Synthetics Recorder extension in the browser.
   - Click "Start recording".
   - Perform desired actions (e.g., for `scorekeep`):
     - Change user to "Canary".
     - Set game name to "Canary".
     - Create a session.
   - Return to the extension and click "End recording".
   - Copy the generated script to the clipboard.

3. **Create the Canary**:
   - Return to CloudWatch Management Console.
   - Name the canary (e.g., `scorekeepapp`).
   - Paste the recorded script into the script editor (or upload a saved script file).
   - Note: The script hardcodes the application URL.
   - **Example Recorded Script Snippet** (simplified Node.js script generated by the plugin):
     ```javascript
     const synthetics = require('Synthetics');
     const log = require('SyntheticsLogger');
     const syntheticsConfiguration = synthetics.getConfiguration();

     exports.handler = async () => {
         syntheticsConfiguration.setConfig({
             screenshotOnStepSuccess: true,
             screenshotOnStepFailure: true
         });

         let page = await synthetics.getPage();
         await synthetics.executeStep('Navigate to scorekeep', async function () {
             await page.goto('https://scorekeep.example.com', { waitUntil: 'domcontentloaded' });
         });

         await synthetics.executeStep('Set user to Canary', async function () {
             await page.type('#userInput', 'Canary');
         });

         await synthetics.executeStep('Set game to Canary', async function () {
             await page.type('#gameInput', 'Canary');
         });

         await synthetics.executeStep('Create session', async function () {
             await page.click('#createSessionButton');
         });
     };
     ```
   - Save and create the canary.

4. **Analyze Canary Results**:
   - Navigate to the canary (e.g., `scorekeepapp`) in the CloudWatch console.
   - Check the latest run status (e.g., "passed").
   - Review details:
     - **Steps**: Lists executed steps (default names may be generic; can be edited for clarity).
     - **Screenshots**: View screenshots taken during execution.
     - **Logs**: Debug execution issues.
     - **HAR File**: Analyze network requests made during the run.
   - **Example Step Name Modification** (edit script to improve clarity):
     ```javascript
     // Before
     await synthetics.executeStep('step_1', async function () {
         await page.type('#userInput', 'Canary');
     });
     // After
     await synthetics.executeStep('Set user to Canary', async function () {
         await page.type('#userInput', 'Canary');
     });
     ```

## Benefits
- **Ease of Use**: Eliminates manual script writing by recording browser interactions.
- **Complex Scenarios**: Simplifies testing of multi-step user flows (e.g., form inputs, button clicks).
- **Reliability**: Ensures critical application components function as expected by replicating user actions.
- **Comprehensive Output**: Provides screenshots, logs, and network request data for analysis.

## Limitations
- Hardcoded URLs in the generated script may require manual updates for dynamic environments.
- Default step names may be generic and need editing for better readability.

## Next Steps
- Modify the recorded script to include dynamic values or additional steps.
- Integrate with CloudWatch alarms for automated issue notifications.
